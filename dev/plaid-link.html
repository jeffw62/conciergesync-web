<script>
document.addEventListener("DOMContentLoaded", () => {
  async function openPlaid() {
    try {
      // 1️⃣ Ask YOUR server for a fresh link_token
      const response = await fetch("/api/plaid/link-token");
      const data = await response.json();

      console.log("Link token received:", data);

      // 2️⃣ Create Plaid Link using the server-issued token
      const handler = Plaid.create({
        token: data.link_token,

        onSuccess: async function (public_token, metadata) {
          console.log("Plaid success:", public_token, metadata);

          // 3️⃣ Send public_token back to your server
          await fetch("/api/plaid/exchange", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ public_token })
          });

          alert("Bank connected successfully.");
        },

        onExit: function (err, metadata) {
          console.log("Plaid exited:", err, metadata);
        }
      });

      handler.open();

    } catch (err) {
      console.error("Plaid failed to initialize:", err);
    }
  }

  const button = document.getElementById("link-button");
  if (!button) {
    console.error("❌ link-button not found in DOM");
    return;
  }

  button.addEventListener("click", openPlaid);
});
</script>
