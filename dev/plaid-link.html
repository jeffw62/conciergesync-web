<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ConciergeSync Plaid Test</title>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>

<body>
  <h1>ConciergeSync Internal Plaid Test</h1>

  <button id="link-button">Connect Account</button>

  <script>
    async function openPlaid() {
      const response = await fetch("/api/plaid/link-token");
      const data = await response.json();

      const handler = Plaid.create({
        token: data.link_token,
      
        onSuccess: async (public_token, metadata) => {
          const user = firebase.auth().currentUser;
      
          if (!user) {
            alert("User not authenticated");
            return;
          }
      
          const cs_user_id = user.uid;
      
          console.log("ðŸ‘¤ CS USER ID:", cs_user_id);
          console.log("ðŸ¦ PLAID METADATA (non-canonical):", metadata);
      
          await fetch("/api/plaid/exchange", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              public_token,
              cs_user_id
            })
          });
      
          alert("Bank connected successfully");
        },
      
        onExit: (err) => console.log("Exited", err)
      });

      handler.open();
    }

    document.addEventListener("DOMContentLoaded", () => {
      document
        .getElementById("link-button")
        .addEventListener("click", openPlaid);
    });
  </script>
</body>
</html>
