<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ConciergeSync Plaid Test</title>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>

<body>
  <h1>ConciergeSync Internal Plaid Test</h1>

  <button id="link-button">Connect Account</button>

  <script>
    // ðŸ”‘ ConciergeSync authenticated user (TEMP hardcode)
    window.CS_USER_ID = "cs_e9e66863d68388548ba1";
  </script>

  <script>
  async function openPlaid() {
    const response = await fetch("/api/plaid/link-token");
    const data = await response.json();

    const handler = Plaid.create({
      token: data.link_token,

      onSuccess: async (public_token, metadata) => {
        // ðŸ”‘ HARD REQUIREMENT
        const cs_user_id = window.CS_USER_ID;

        if (!cs_user_id) {
          alert("Missing user identity. Please reload.");
          return;
        }

        console.log("ðŸ‘¤ CS USER ID (client):", cs_user_id);
        console.log("ðŸ¦ PLAID METADATA:", metadata);

        await fetch("/api/plaid/exchange", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            cs_user_id,                    // âœ… THIS FIXES EVERYTHING
            public_token,
            institution: metadata?.institution || null
          })
        });

        alert("Bank connected successfully");
      },

      onExit: (err) => console.log("Exited", err)
    });

    handler.open();
  }

  document.addEventListener("DOMContentLoaded", () => {
    document
      .getElementById("link-button")
      .addEventListener("click", openPlaid);
  });
</script>
</body>
</html>
